# Contributor: SÃ¶ren Tempel <soeren+alpine@soeren-tempel.net>
# Contributor: Carlo Landmeter <clandmeter@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=unbound
pkgver=1.5.7
pkgrel=1
pkgdesc="Unbound is a validating, recursive, and caching DNS resolver"
pkgusers="unbound"
pkggroups="unbound"
url="http://unbound.net/"
arch="all"
license="BSD"
depends="dnssec-root"
depends_dev="openssl-dev expat-dev ldns-dev"
makedepends="$depends_dev linux-headers"
install="$pkgname.pre-install"
subpackages="$pkgname-dev $pkgname-doc $pkgname-libs $pkgname-dbg"
source="http://unbound.net/downloads/unbound-$pkgver.tar.gz"

_builddir="$srcdir"/unbound-$pkgver
prepare() {
  local i
  cd "$_builddir"
  for i in $source; do
    case $i in
    *.patch) msg $i; patch -p1 -i "$srcdir"/$i || return 1;;
    esac
  done
}

build() {
  cd "$_builddir"
  ./configure \
    --build=$CBUILD \
    --host=$CHOST \
    --prefix=/usr \
    --sysconfdir=/etc \
    --mandir=/usr/share/man \
    --localstatedir=/var \
    --with-username=unbound \
    --with-run-dir="" \
    --with-pidfile=/var/run/unbound/unbound.pid \
    --with-rootkey-file=/usr/share/dnssec-root/trusted-key.key \
    --without-pthreads \
    --disable-static \
    --disable-rpath \
    --with-ssl \
    --without-pythonmodule \
    --without-pyunbound \
    || return 1

  # do not link to libpython
  sed -i -e '/^LIBS=/s/-lpython.*[[:space:]]/ /' Makefile

  make || return 1
}

package() {
  cd "$_builddir"
  make DESTDIR="$pkgdir" install || return 1
  install -D contrib/update-anchor.sh \
    "$pkgdir"/usr/share/$pkgname/update-anchor.sh \
    || return 1

  install -d -o unbound -g unbound "$pkgdir"/var/run/unbound || return 1

  mkdir -p "$pkgdir"/usr/share/doc/$pkgname/
  for name in CREDITS Changelog FEATURES README TODO; do
    install -m644 "$_builddir"/doc/$name \
      "$pkgdir"/usr/share/doc/$pkgname/$name || return 1
  done
}

libs() {
  pkgdesc="unbound shared libraries"
  mkdir -p "$subpkgdir"/usr/lib
  mv "$pkgdir"/usr/lib/lib*.so.* "$subpkgdir"/usr/lib/
}

md5sums="a1253cbbb339dbca03404dcc58365d71  unbound-1.5.7.tar.gz"
sha256sums="4b2088e5aa81a2d48f6337c30c1cf7e99b2e2dc4f92e463b3bee626eee731ca8  unbound-1.5.7.tar.gz"
sha512sums="7fc000364139519ed837ef9883f2e8a684b5ac19f2d3343626ab0a4c3459a7c3ccf2c79e9d992d82b123c6a38245fc286994365b427145d218e0b3c645c4dc4f  unbound-1.5.7.tar.gz"
